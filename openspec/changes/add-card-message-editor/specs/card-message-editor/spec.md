# Capability: Card Message Editor

カードタイプメッセージを作成・編集・送信するためのビジュアルエディタ

## ADDED Requirements

### Requirement: カードタイプ選択

システムは、ユーザーが4種類のカードタイプから選択できるMUSTを提供する。

#### Scenario: 商品タイプの選択
- **WHEN** ユーザーが「商品タイプ」を選択する
- **THEN** タイトル、説明、価格、画像の入力フィールドが表示される

#### Scenario: 場所タイプの選択
- **WHEN** ユーザーが「場所タイプ」を選択する
- **THEN** タイトル、住所、営業時間、画像の入力フィールドが表示される

#### Scenario: 人物タイプの選択
- **WHEN** ユーザーが「人物タイプ」を選択する
- **THEN** 名前、説明、タグ、画像の入力フィールドが表示される

#### Scenario: 画像タイプの選択
- **WHEN** ユーザーが「画像タイプ」を選択する
- **THEN** 画像、タイトル（オプション）、説明（オプション）の入力フィールドが表示される

### Requirement: カードの動的管理

システムは、ユーザーがカードを動的に追加・編集・削除できるMUSTを提供する。

#### Scenario: カードの追加
- **WHEN** ユーザーが「カードを追加」ボタンをクリックする
- **AND** 現在のカード数が9枚未満である
- **THEN** 新しいカードがリストに追加される
- **AND** カードタイプ選択ダイアログが表示される

#### Scenario: カード数の上限
- **WHEN** ユーザーが「カードを追加」ボタンをクリックする
- **AND** 現在のカード数が9枚である
- **THEN** エラーメッセージ「最大9枚までカードを作成できます」が表示される
- **AND** カードは追加されない

#### Scenario: カードの編集
- **WHEN** ユーザーが既存カードの編集ボタンをクリックする
- **THEN** 該当カードの編集フォームが表示される
- **AND** 現在の値が入力フィールドに表示される

#### Scenario: カードの削除
- **WHEN** ユーザーがカードの削除ボタンをクリックする
- **AND** 確認ダイアログで「削除」を選択する
- **THEN** 該当カードがリストから削除される

#### Scenario: カードの並び替え
- **WHEN** ユーザーがカードをドラッグ&ドロップする
- **THEN** カードの順序が変更される
- **AND** プレビューに反映される

#### Scenario: 最小カード数の制限
- **WHEN** ユーザーが最後のカードを削除しようとする
- **THEN** エラーメッセージ「少なくとも1枚のカードが必要です」が表示される
- **AND** カードは削除されない

### Requirement: 商品タイプカードの入力

システムは、商品タイプカードの詳細情報を入力できるMUSTを提供する。

#### Scenario: 商品情報の入力
- **WHEN** ユーザーが商品タイプカードのフォームに入力する
- **THEN** 以下の項目が入力可能である
  - タイトル（必須、最大40文字）
  - 説明（必須、最大60文字）
  - 価格（オプション、数値）
  - 画像URL（必須、HTTPS、1:1.51の比率推奨）

#### Scenario: 商品情報のバリデーション
- **WHEN** ユーザーがタイトルに41文字以上入力する
- **THEN** エラーメッセージ「タイトルは40文字以内で入力してください」が表示される

#### Scenario: 画像のアップロード
- **WHEN** ユーザーが画像をアップロードする
- **THEN** Cloudinaryにアップロードされる
- **AND** アップロード後のHTTPS URLが自動的に設定される

### Requirement: 場所タイプカードの入力

システムは、場所タイプカードの詳細情報を入力できるMUSTを提供する。

#### Scenario: 場所情報の入力
- **WHEN** ユーザーが場所タイプカードのフォームに入力する
- **THEN** 以下の項目が入力可能である
  - タイトル（必須、最大40文字）
  - 住所（必須、最大60文字）
  - 営業時間（オプション、最大60文字）
  - 画像URL（必須、HTTPS、1:1.51の比率推奨）

#### Scenario: 場所情報のバリデーション
- **WHEN** ユーザーが住所を入力せずに保存しようとする
- **THEN** エラーメッセージ「住所は必須項目です」が表示される

### Requirement: 人物タイプカードの入力

システムは、人物タイプカードの詳細情報を入力できるMUSTを提供する。

#### Scenario: 人物情報の入力
- **WHEN** ユーザーが人物タイプカードのフォームに入力する
- **THEN** 以下の項目が入力可能である
  - 名前（必須、最大40文字）
  - 説明（必須、最大60文字）
  - タグ（オプション、複数、各タグ最大20文字）
  - 画像URL（必須、HTTPS、1:1の比率推奨）

#### Scenario: タグの追加
- **WHEN** ユーザーがタグ入力フィールドに入力してEnterを押す
- **THEN** 新しいタグがリストに追加される
- **AND** 入力フィールドがクリアされる

#### Scenario: タグの削除
- **WHEN** ユーザーがタグの削除ボタンをクリックする
- **THEN** 該当タグがリストから削除される

### Requirement: 画像タイプカードの入力

システムは、画像タイプカードの詳細情報を入力できるMUSTを提供する。

#### Scenario: 画像情報の入力
- **WHEN** ユーザーが画像タイプカードのフォームに入力する
- **THEN** 以下の項目が入力可能である
  - 画像URL（必須、HTTPS、1:1.51の比率推奨）
  - タイトル（オプション、最大40文字）
  - 説明（オプション、最大60文字）

#### Scenario: 画像のみのカード
- **WHEN** ユーザーが画像のみを設定する
- **AND** タイトルと説明を空白のままにする
- **THEN** 画像のみのカードとして作成される

### Requirement: アクション設定

システムは、各カードにアクションボタンを設定できるMUSTを提供する。

#### Scenario: アクションの追加
- **WHEN** ユーザーが「アクションを追加」ボタンをクリックする
- **AND** 現在のアクション数が3つ未満である
- **THEN** 新しいアクション入力フィールドが表示される

#### Scenario: アクション数の上限
- **WHEN** ユーザーが「アクションを追加」ボタンをクリックする
- **AND** 現在のアクション数が3つである
- **THEN** エラーメッセージ「最大3つまでアクションを設定できます」が表示される

#### Scenario: URIアクションの設定
- **WHEN** ユーザーがアクションタイプで「URI」を選択する
- **THEN** ラベル（必須、最大20文字）とURI（必須、HTTPS）の入力フィールドが表示される

#### Scenario: Messageアクションの設定
- **WHEN** ユーザーがアクションタイプで「Message」を選択する
- **THEN** ラベル（必須、最大20文字）とテキスト（必須、最大300文字）の入力フィールドが表示される

#### Scenario: Postbackアクションの設定
- **WHEN** ユーザーがアクションタイプで「Postback」を選択する
- **THEN** ラベル（必須、最大20文字）、データ（必須、最大300文字）、表示テキスト（オプション）の入力フィールドが表示される

#### Scenario: アクションの削除
- **WHEN** ユーザーがアクションの削除ボタンをクリックする
- **THEN** 該当アクションがリストから削除される

### Requirement: カルーセルプレビュー

システムは、作成中のカードをリアルタイムでプレビュー表示するMUSTを提供する。

#### Scenario: プレビューの表示
- **WHEN** ユーザーがカードを追加・編集する
- **THEN** プレビューエリアにカルーセル形式でカードが表示される
- **AND** 各カードの画像、タイトル、説明が表示される

#### Scenario: プレビューのスクロール
- **WHEN** ユーザーがプレビューエリアで左右にスワイプする
- **THEN** カードが横スクロールされる
- **AND** 複数のカードを確認できる

#### Scenario: プレビューの更新
- **WHEN** ユーザーがカードの内容を変更する
- **THEN** プレビューがリアルタイムで更新される

### Requirement: バリデーション

システムは、カード送信前に包括的なバリデーションを実行するMUSTを提供する。

#### Scenario: 必須項目のチェック
- **WHEN** ユーザーが送信ボタンをクリックする
- **AND** いずれかのカードで必須項目が未入力である
- **THEN** エラーメッセージ「カード{番号}: {項目名}は必須項目です」が表示される
- **AND** 該当カードがハイライト表示される

#### Scenario: 文字数制限のチェック
- **WHEN** ユーザーが送信ボタンをクリックする
- **AND** いずれかの項目が文字数制限を超えている
- **THEN** エラーメッセージ「カード{番号}: {項目名}は{制限}文字以内で入力してください」が表示される

#### Scenario: URL形式のチェック
- **WHEN** ユーザーが送信ボタンをクリックする
- **AND** いずれかのURLが不正な形式である
- **THEN** エラーメッセージ「カード{番号}: 有効なHTTPS URLを入力してください」が表示される

#### Scenario: 全てのバリデーション通過
- **WHEN** ユーザーが送信ボタンをクリックする
- **AND** 全てのバリデーションが通過する
- **THEN** LINE APIにカルーセルメッセージが送信される

### Requirement: メッセージ送信

システムは、作成したカードをLINE Messaging APIのCarousel Template形式で送信するMUSTを提供する。

#### Scenario: Carousel Templateへの変換
- **WHEN** ユーザーが送信ボタンをクリックする
- **THEN** 各カードタイプの情報がLINE Carousel Templateの形式に変換される
- **AND** `/api/line/send` エンドポイントにPOSTリクエストが送信される

#### Scenario: 商品タイプの変換
- **WHEN** 商品タイプカードが送信される
- **THEN** 以下の形式に変換される
  - `thumbnailImageUrl`: 画像URL
  - `title`: タイトル
  - `text`: 「{説明}\n価格: {価格}円」（価格が設定されている場合）
  - `actions`: 設定されたアクション配列

#### Scenario: 場所タイプの変換
- **WHEN** 場所タイプカードが送信される
- **THEN** 以下の形式に変換される
  - `thumbnailImageUrl`: 画像URL
  - `title`: タイトル
  - `text`: 「{住所}\n営業時間: {営業時間}」（営業時間が設定されている場合）
  - `actions`: 設定されたアクション配列

#### Scenario: 人物タイプの変換
- **WHEN** 人物タイプカードが送信される
- **THEN** 以下の形式に変換される
  - `thumbnailImageUrl`: 画像URL
  - `title`: 名前
  - `text`: 「{説明}\n#{タグ1} #{タグ2}...」（タグが設定されている場合）
  - `actions`: 設定されたアクション配列

#### Scenario: 画像タイプの変換
- **WHEN** 画像タイプカードが送信される
- **THEN** 以下の形式に変換される
  - `thumbnailImageUrl`: 画像URL
  - `title`: タイトル（設定されている場合）
  - `text`: 説明（設定されている場合）
  - `actions`: 設定されたアクション配列

#### Scenario: 送信成功
- **WHEN** LINE APIへの送信が成功する
- **THEN** 成功メッセージ「メッセージを送信しました」が表示される
- **AND** デバッグパネルにリクエスト・レスポンスが表示される（開発環境）

#### Scenario: 送信失敗
- **WHEN** LINE APIへの送信が失敗する
- **THEN** エラーメッセージが表示される
- **AND** デバッグパネルにエラー詳細が表示される（開発環境）

### Requirement: データ永続化

システムは、作成中のカードデータをブラウザのlocalStorageに自動保存するMUST機能を提供する。

#### Scenario: 自動保存
- **WHEN** ユーザーがカードの内容を変更する
- **THEN** 変更後3秒後にlocalStorageに自動保存される

#### Scenario: データの復元
- **WHEN** ユーザーがページをリロードする
- **AND** localStorageに保存されたデータが存在する
- **THEN** 保存されたカード情報が復元される
- **AND** 復元通知「前回の編集内容を復元しました」が表示される

#### Scenario: データのクリア
- **WHEN** ユーザーが送信に成功する
- **THEN** localStorageのデータがクリアされる

### Requirement: レスポンシブ対応

システムは、デスクトップ、タブレット、モバイルで操作可能なインターフェースを提供するMUSTがある。

#### Scenario: デスクトップ表示
- **WHEN** デスクトップブラウザでアクセスする
- **THEN** サイドバイサイドでエディタとプレビューが表示される

#### Scenario: タブレット表示
- **WHEN** タブレットでアクセスする
- **THEN** 縦スクロールでエディタとプレビューが表示される

#### Scenario: モバイル表示
- **WHEN** モバイルでアクセスする
- **THEN** シングルカラムで表示される
- **AND** カード追加・編集は可能だが、ドラッグ&ドロップは利用不可
