# Proposal: Add Rich Message Image Editor

## Summary

リッチメッセージページに、LINE Official Account Manager と同様の画像設定UIを実装します。画像のアップロード、プレビュー表示、タップ可能なエリアのビジュアル設定、各エリアのアクション設定を可能にします。

## Motivation

- **現状の課題**:
  - 現在のリッチメッセージページは画像URLを手動入力する必要がある
  - タップエリアの座標を手動で計算・入力する必要がある
  - 画像のプレビューがなく、視覚的に確認できない
  - LINE Manager と比較してUXが大幅に劣る

- **ビジネス価値**:
  - 画像アップロードからエリア設定までをシームレスに実行
  - 視覚的にタップエリアを設定できるため、ミスが減少
  - LINE Manager と同等の操作性で、アプリケーション内で完結

- **ユーザー体験の向上**:
  - ドラッグ&ドロップで画像アップロード
  - 画像上でクリック/ドラッグしてエリア設定
  - リアルタイムプレビュー

## Goals

1. **画像アップロード機能**: Cloudinary へのアップロードとプレビュー表示
2. **ビジュアルエリアエディタ**: 画像上でタップエリアを視覚的に設定
3. **アクション設定UI**: 各エリアに対するアクション（URI/Message）の設定
4. **プレビュー機能**: 設定したリッチメッセージのプレビュー表示

## Non-Goals

- 複雑なエリア形状（矩形以外）のサポート
- アニメーション・動画のサポート
- テンプレート保存機能（将来的な拡張）
- 複数画像の管理（単一画像のみ）

## Proposed Solution

### アーキテクチャ概要

1. **画像アップロードコンポーネント**:
   - 既存の `/api/uploads/image` を使用
   - ドラッグ&ドロップ、ファイル選択、クリップボード貼り付けをサポート
   - Cloudinary URL を自動取得

2. **ビジュアルエリアエディタ**:
   - Canvas または div ベースのエディタ
   - マウスドラッグで矩形エリアを作成
   - 既存エリアの移動・リサイズ
   - エリアの削除

3. **アクション設定パネル**:
   - 各エリアをクリックして選択
   - アクションタイプ選択（URI / Message）
   - URI または Message テキストを入力

4. **プレビュー**:
   - 設定した内容をリアルタイムで確認
   - LINE風のUI表示

### 主要機能

1. **画像アップロード**:
   - ファイル選択ボタン
   - ドラッグ&ドロップエリア
   - クリップボードからの貼り付け（Ctrl/Cmd + V）
   - アップロード中の進捗表示

2. **エリア設定**:
   - 画像上でマウスドラッグして矩形エリアを作成
   - 作成したエリアは半透明のオーバーレイで表示
   - エリアをクリックして選択（ハイライト表示）
   - 選択エリアのリサイズハンドル
   - 削除ボタン

3. **アクション設定**:
   - 選択エリアのアクションタイプ選択
   - URI アクション: URL入力フィールド
   - Message アクション: テキスト入力フィールド
   - アクション内容のバリデーション

4. **座標計算**:
   - 1040x1040 基準での座標計算
   - 表示サイズと実際の座標の変換
   - LINE API 形式への変換

## Affected Capabilities

- **rich-message-editor**: 新規追加 - リッチメッセージの画像とエリアの視覚的編集

## Alternatives Considered

### 1. 外部ツールの統合
- **却下理由**: 外部ツールへの依存を増やしたくない。自前で実装した方が統合が容易。

### 2. Canvas ベースのエディタ
- **採用可能**: より柔軟だが、実装が複雑
- **検討**: まずは div ベースで実装し、必要に応じて Canvas に移行

### 3. テンプレートライブラリの提供
- **却下理由**: 初期バージョンでは過剰。将来的な拡張として検討。

## Migration Strategy

1. **既存機能への影響**:
   - 既存のリッチメッセージページを拡張
   - 手動URL入力も残す（上級ユーザー向け）

2. **段階的なロールアウト**:
   - フェーズ1: 画像アップロード機能の追加
   - フェーズ2: ビジュアルエリアエディタの実装
   - フェーズ3: アクション設定UIの統合
   - フェーズ4: プレビュー機能の追加

## Technical Considerations

### 1. 座標系の変換
- 表示サイズ（可変）と LINE API 要求サイズ（1040x1040 固定）の変換
- アスペクト比の維持

### 2. レスポンシブ対応
- 画像エディタのサイズ調整
- モバイルデバイスでの操作性

### 3. エリア数の制限
- LINE API の制限を確認
- 最大エリア数の設定

## Success Metrics

- 画像アップロード機能の利用率
- エリア設定の平均時間（手動入力と比較）
- エラー発生率（座標ミスなど）
- ユーザー満足度

## Timeline

- 画像アップロード実装: 1日
- ビジュアルエディタ実装: 2-3日
- アクション設定UI: 1日
- プレビュー機能: 1日
- テストと調整: 1日

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|-----------|
| 座標計算のバグ | High | 十分なテストとプレビュー機能での確認 |
| ブラウザ互換性 | Medium | モダンブラウザのみサポート、フォールバック提供 |
| 画像サイズの制限 | Medium | アップロード時に検証、適切なエラーメッセージ |
| UX の複雑化 | Low | シンプルなデフォルト設定、段階的な機能提供 |
