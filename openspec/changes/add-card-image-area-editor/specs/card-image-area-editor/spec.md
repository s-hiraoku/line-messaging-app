# Capability: Card Image Area Editor

カードタイプメッセージの画像を複数の領域に分割し、各領域にテキストラベルとアクションを設定するビジュアルエディタ

## ADDED Requirements

### Requirement: 画像エリアの有効化

システムは、ユーザーがカード画像のエリア分割機能を有効化できるMUSTを提供する。

#### Scenario: エリア分割機能の有効化
- **WHEN** ユーザーが画像アップロード後に「画像エリア分割を有効にする」トグルをONにする
- **THEN** 画像エリアエディタが表示される
- **AND** ビジュアルキャンバス、領域リスト、領域編集フォームが利用可能になる

#### Scenario: エリア分割機能の無効化
- **WHEN** ユーザーが「画像エリア分割を有効にする」トグルをOFFにする
- **THEN** 画像エリアエディタが非表示になる
- **AND** 定義済みの画像エリアが削除される
- **AND** 確認ダイアログ「すべての画像エリアが削除されます。よろしいですか?」が表示される

#### Scenario: 画像未アップロード時
- **WHEN** ユーザーが画像をアップロードしていない状態で「画像エリア分割を有効にする」トグルをONにする
- **THEN** エラーメッセージ「画像をアップロードしてください」が表示される
- **AND** トグルは無効のまま維持される

### Requirement: 画像エリアの追加

システムは、ユーザーが画像上に新しいタップ可能な領域を追加できるMUSTを提供する。

#### Scenario: 領域の追加
- **WHEN** ユーザーが「エリアを追加」ボタンをクリックする
- **AND** 現在の領域数が10個未満である
- **THEN** 新しい領域がキャンバス中央に追加される
- **AND** 領域リストに新しい項目が表示される
- **AND** 領域編集フォームが開き、新しい領域が選択状態になる

#### Scenario: 領域数の上限
- **WHEN** ユーザーが「エリアを追加」ボタンをクリックする
- **AND** 現在の領域数が10個である
- **THEN** エラーメッセージ「画像エリアは最大10個まで追加できます」が表示される
- **AND** 新しい領域は追加されない

#### Scenario: キャンバス上でのドラッグ追加
- **WHEN** ユーザーがキャンバス上で左クリックしてドラッグする
- **AND** 現在の領域数が10個未満である
- **THEN** ドラッグした範囲に新しい領域が作成される
- **AND** 領域の座標とサイズがドラッグ範囲に基づいて設定される

### Requirement: 画像エリアの編集

システムは、ユーザーが定義済みの画像エリアを編集できるMUSTを提供する。

#### Scenario: 領域の選択
- **WHEN** ユーザーがキャンバス上の領域をクリックする
- **THEN** 該当領域が選択状態になる
- **AND** 領域がハイライト表示される
- **AND** リサイズハンドル(4隅 + 4辺)が表示される
- **AND** 領域編集フォームに該当領域の情報が表示される

#### Scenario: 領域の移動(ドラッグ)
- **WHEN** ユーザーが選択中の領域をドラッグする
- **THEN** 領域がマウスカーソルに追従して移動する
- **AND** 領域編集フォームの座標(X, Y)がリアルタイムで更新される
- **AND** 画像範囲外への移動は制限される

#### Scenario: 領域のリサイズ
- **WHEN** ユーザーがリサイズハンドルをドラッグする
- **THEN** 領域のサイズが変更される
- **AND** 領域編集フォームのサイズ(幅, 高さ)がリアルタイムで更新される
- **AND** 最小サイズ(20x20px)未満には縮小できない
- **AND** 画像範囲外へのリサイズは制限される

#### Scenario: 座標の数値入力
- **WHEN** ユーザーが領域編集フォームで座標(X, Y)を数値入力する
- **THEN** キャンバス上の領域位置が更新される
- **AND** 入力値が画像範囲外の場合は自動的に補正される

#### Scenario: サイズの数値入力
- **WHEN** ユーザーが領域編集フォームでサイズ(幅, 高さ)を数値入力する
- **THEN** キャンバス上の領域サイズが更新される
- **AND** 入力値が最小サイズ(20x20px)未満の場合は20pxに補正される

### Requirement: テキストラベルの設定

システムは、ユーザーが各画像エリアにテキストラベルを設定できるMUSTを提供する。

#### Scenario: ラベルの入力
- **WHEN** ユーザーが領域編集フォームで「テキストラベル」フィールドに入力する
- **THEN** 入力内容がキャンバス上の該当領域内に表示される
- **AND** 最大20文字まで入力可能である

#### Scenario: ラベルのバリデーション
- **WHEN** ユーザーがテキストラベルを空白のままにする
- **AND** 保存または送信を試みる
- **THEN** エラーメッセージ「テキストラベルは必須です」が表示される

#### Scenario: ラベル位置の調整(ドラッグ)
- **WHEN** ユーザーがキャンバス上のテキストラベルをドラッグする
- **THEN** ラベルが領域内で移動する
- **AND** 領域外への移動は制限される
- **AND** ラベル位置が相対座標として保存される

#### Scenario: ラベル位置の自動調整
- **WHEN** ユーザーが領域のサイズを変更する
- **AND** ラベルが領域外にはみ出す
- **THEN** ラベルが自動的に領域内の中央に再配置される

### Requirement: アクションの設定

システムは、ユーザーが各画像エリアにアクションを設定できるMUSTを提供する。

#### Scenario: URIアクションの設定
- **WHEN** ユーザーが領域編集フォームでアクションタイプ「URI」を選択する
- **THEN** URI入力フィールドが表示される
- **AND** HTTPS URLを入力できる

#### Scenario: Messageアクションの設定
- **WHEN** ユーザーが領域編集フォームでアクションタイプ「Message」を選択する
- **THEN** テキスト入力フィールドが表示される
- **AND** 最大300文字まで入力可能である

#### Scenario: Postbackアクションの設定
- **WHEN** ユーザーが領域編集フォームでアクションタイプ「Postback」を選択する
- **THEN** データ入力フィールドと表示テキスト入力フィールドが表示される
- **AND** データは最大300文字まで入力可能である

#### Scenario: アクションの必須チェック
- **WHEN** ユーザーがアクションを設定せずに保存または送信を試みる
- **THEN** エラーメッセージ「アクションは必須です」が表示される

### Requirement: 画像エリアの削除

システムは、ユーザーが定義済みの画像エリアを削除できるMUSTを提供する。

#### Scenario: 領域の削除
- **WHEN** ユーザーが領域編集フォームまたは領域リストで「削除」ボタンをクリックする
- **THEN** 確認ダイアログ「このエリアを削除しますか?」が表示される

#### Scenario: 削除の確認
- **WHEN** ユーザーが削除確認ダイアログで「削除」を選択する
- **THEN** 該当領域がキャンバスから削除される
- **AND** 領域リストから削除される
- **AND** 選択状態が解除される

#### Scenario: 削除のキャンセル
- **WHEN** ユーザーが削除確認ダイアログで「キャンセル」を選択する
- **THEN** 領域は削除されない
- **AND** ダイアログが閉じる

### Requirement: 領域の並び替え

システムは、ユーザーが定義済みの画像エリアの順序を変更できるMUSTを提供する。

#### Scenario: ドラッグ&ドロップでの並び替え
- **WHEN** ユーザーが領域リスト内で領域をドラッグ&ドロップする
- **THEN** 領域の順序が変更される
- **AND** キャンバス上のZ-order(重なり順)が変更される

#### Scenario: 上下移動ボタンでの並び替え
- **WHEN** ユーザーが領域リストで「上へ移動」または「下へ移動」ボタンをクリックする
- **THEN** 該当領域が1つ上または下に移動する
- **AND** 最上位の領域で「上へ移動」は無効である
- **AND** 最下位の領域で「下へ移動」は無効である

### Requirement: ビジュアルエディタ(キャンバス)

システムは、ユーザーが画像上で視覚的に領域を編集できるMUSTを提供する。

#### Scenario: キャンバスの表示
- **WHEN** ユーザーが画像エリア分割機能を有効にする
- **THEN** アップロード済み画像がキャンバスに表示される
- **AND** 定義済みの領域が半透明の矩形で表示される
- **AND** 各領域のテキストラベルが表示される

#### Scenario: ズーム機能
- **WHEN** ユーザーがマウスホイールをスクロールする
- **THEN** キャンバスがズームイン/アウトする
- **AND** ズーム率が50%〜200%の範囲で変更される
- **AND** 領域の座標・サイズは元画像基準のまま維持される

#### Scenario: パン機能
- **WHEN** ユーザーがキャンバスの空白領域をドラッグする
- **THEN** キャンバスが移動(パン)する
- **AND** 画像全体を確認できる

#### Scenario: グリッド表示
- **WHEN** ユーザーが「グリッドを表示」トグルをONにする
- **THEN** キャンバスに10px間隔のグリッドが表示される
- **AND** 領域の位置・サイズ調整がしやすくなる

#### Scenario: スナップ機能
- **WHEN** ユーザーが「スナップを有効化」トグルをONにする
- **AND** 領域をドラッグまたはリサイズする
- **THEN** 領域がグリッドまたは他の領域の境界にスナップする

### Requirement: 領域リスト

システムは、ユーザーが定義済みの画像エリア一覧を確認できるMUSTを提供する。

#### Scenario: 領域リストの表示
- **WHEN** ユーザーが画像エリアエディタを開く
- **THEN** 定義済みの領域が一覧表示される
- **AND** 各領域の情報(ラベル、座標、サイズ、アクションタイプ)が表示される

#### Scenario: 領域リストからの選択
- **WHEN** ユーザーが領域リスト内の領域をクリックする
- **THEN** キャンバス上の該当領域が選択状態になる
- **AND** 領域編集フォームに該当領域の情報が表示される

#### Scenario: 領域の検索
- **WHEN** ユーザーが領域リストの検索フィールドに入力する
- **THEN** 入力内容に一致するラベルを持つ領域のみが表示される

### Requirement: バリデーション

システムは、画像エリア送信前に包括的なバリデーションを実行するMUSTを提供する。

#### Scenario: 必須項目のチェック
- **WHEN** ユーザーが送信ボタンをクリックする
- **AND** いずれかの領域でテキストラベルまたはアクションが未設定である
- **THEN** エラーメッセージ「エリア{番号}: {項目名}は必須項目です」が表示される
- **AND** 該当領域がハイライト表示される

#### Scenario: 文字数制限のチェック
- **WHEN** ユーザーが送信ボタンをクリックする
- **AND** いずれかの領域のテキストラベルが20文字を超えている
- **THEN** エラーメッセージ「エリア{番号}: テキストラベルは20文字以内で入力してください」が表示される

#### Scenario: 座標・サイズの妥当性チェック
- **WHEN** ユーザーが送信ボタンをクリックする
- **AND** いずれかの領域が画像範囲外にはみ出している
- **THEN** エラーメッセージ「エリア{番号}: 領域が画像範囲外にはみ出しています」が表示される

#### Scenario: URL形式のチェック
- **WHEN** ユーザーが送信ボタンをクリックする
- **AND** いずれかの領域のURIアクションが不正な形式である
- **THEN** エラーメッセージ「エリア{番号}: 有効なHTTPS URLを入力してください」が表示される

#### Scenario: 領域の重複チェック
- **WHEN** ユーザーが送信ボタンをクリックする
- **AND** 2つ以上の領域が50%以上重複している
- **THEN** 警告メッセージ「エリア{番号}とエリア{番号}が重複しています」が表示される
- **AND** 送信は可能(警告のみ、エラーではない)

### Requirement: テキスト画像合成

システムは、画像エリアのテキストラベルを画像に合成してLINE APIに送信可能な形式に変換するMUSTを提供する。

#### Scenario: Cloudinary Transformation API での合成
- **WHEN** ユーザーが送信ボタンをクリックする
- **AND** 画像エリアが定義されている
- **THEN** 各領域のテキストラベルを Cloudinary Transformation API を使用して画像に合成する
- **AND** 合成後の画像URLを取得する

#### Scenario: テキストスタイルの適用
- **WHEN** テキストを画像に合成する
- **THEN** 以下のスタイルが適用される
  - フォント: 'Noto Sans JP' (日本語対応)
  - フォントサイズ: 24px
  - 文字色: 白(#FFFFFF)
  - 背景: 半透明黒(rgba(0,0,0,0.6))
  - 位置: 各領域の labelPosition に基づく

#### Scenario: 合成エラー処理
- **WHEN** Cloudinary API での画像合成が失敗する
- **THEN** エラーメッセージ「画像の合成に失敗しました。再度お試しください」が表示される
- **AND** 送信処理が中断される

### Requirement: LINE API 送信

システムは、画像エリアを含むカードメッセージを LINE Imagemap 形式で送信するMUSTを提供する。

#### Scenario: Imagemap メッセージへの変換
- **WHEN** ユーザーが送信ボタンをクリックする
- **AND** 画像エリアが定義されている
- **THEN** カードメッセージが LINE Imagemap メッセージ形式に変換される
- **AND** 以下の情報が設定される
  - `type`: "imagemap"
  - `baseUrl`: テキスト合成後の画像URL
  - `altText`: カードのタイトルまたは「カードメッセージ」
  - `baseSize`: 画像のサイズ(width, height)
  - `actions`: 各領域のアクション配列

#### Scenario: Imagemap アクションの変換
- **WHEN** 各領域のアクションを Imagemap 形式に変換する
- **THEN** 以下の形式に変換される
  - URIアクション: `{ type: "uri", linkUri: URI, area: { x, y, width, height } }`
  - Messageアクション: `{ type: "message", text: テキスト, area: { x, y, width, height } }`
  - Postbackアクション: `{ type: "postback", data: データ, area: { x, y, width, height } }`(※ Imagemapでは未サポート、Messageに変換)

#### Scenario: 送信成功
- **WHEN** LINE APIへの送信が成功する
- **THEN** 成功メッセージ「メッセージを送信しました」が表示される
- **AND** デバッグパネルにリクエスト・レスポンスが表示される(開発環境)
- **AND** localStorage の画像エリアデータがクリアされる

#### Scenario: 送信失敗
- **WHEN** LINE APIへの送信が失敗する
- **THEN** エラーメッセージが表示される
- **AND** デバッグパネルにエラー詳細が表示される(開発環境)

### Requirement: データ永続化

システムは、編集中の画像エリアデータをブラウザのlocalStorageに自動保存するMUST機能を提供する。

#### Scenario: 自動保存
- **WHEN** ユーザーが画像エリアの内容を変更する
- **THEN** 変更後3秒後にlocalStorageに自動保存される

#### Scenario: データの復元
- **WHEN** ユーザーがページをリロードする
- **AND** localStorageに保存された画像エリアデータが存在する
- **THEN** 保存された画像エリア情報が復元される
- **AND** 復元通知「前回の編集内容を復元しました」が表示される

#### Scenario: データのクリア
- **WHEN** ユーザーが送信に成功する
- **THEN** localStorageの画像エリアデータがクリアされる

### Requirement: キーボード操作

システムは、ユーザーがキーボードで画像エリアを操作できるMUST機能を提供する。

#### Scenario: Tab キーでの領域選択
- **WHEN** ユーザーが Tab キーを押す
- **THEN** 次の領域が選択される
- **AND** Shift + Tab で前の領域に戻る

#### Scenario: 矢印キーでの領域移動
- **WHEN** ユーザーが選択中の領域で矢印キー(↑↓←→)を押す
- **THEN** 領域が1px単位で移動する
- **AND** Shift + 矢印キーで10px単位で移動する

#### Scenario: Deleteキーでの領域削除
- **WHEN** ユーザーが選択中の領域で Delete キーを押す
- **THEN** 削除確認ダイアログが表示される

#### Scenario: Escキーでの選択解除
- **WHEN** ユーザーが Esc キーを押す
- **THEN** 領域の選択が解除される

### Requirement: レスポンシブ対応

システムは、デスクトップ、タブレット、モバイルで操作可能なインターフェースを提供するMUSTがある。

#### Scenario: デスクトップ表示
- **WHEN** デスクトップブラウザでアクセスする
- **THEN** キャンバス、領域リスト、領域編集フォームが横並びで表示される

#### Scenario: タブレット表示
- **WHEN** タブレットでアクセスする
- **THEN** キャンバスが上部に、領域リスト・編集フォームが下部に表示される
- **AND** ドラッグ&ドロップ操作が可能である

#### Scenario: モバイル表示
- **WHEN** モバイルでアクセスする
- **THEN** シングルカラムで表示される
- **AND** キャンバスはタッチ操作でピンチズーム可能である
- **AND** 領域の編集はフォーム入力のみ(ドラッグ不可)
