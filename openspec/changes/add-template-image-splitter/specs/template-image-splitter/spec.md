# Capability: Template Image Splitter

テンプレートベースの画像分割エディタ。1-3分割のプリセットテンプレートから選択し、各エリアに個別の画像を配置してLINE Imagemapメッセージを作成する。

## ADDED Requirements

### Requirement: テンプレート選択
ユーザーは、1-3分割の定義済みテンプレートから選択できる **MUST**

#### Scenario: 1分割テンプレート選択
**GIVEN** ユーザーがテンプレート選択画面にいる
**WHEN** ユーザーが「1分割」テンプレートを選択する
**THEN** システムは1つの画像エリアを持つテンプレートを表示する
**AND** エリア設定フェーズに遷移する

#### Scenario: 2分割（縦）テンプレート選択 - 50/50
**GIVEN** ユーザーがテンプレート選択画面にいる
**WHEN** ユーザーが「2分割（縦）50/50」テンプレートを選択する
**THEN** システムは上下2つのエリアを表示する
**AND** 上エリアは50%の高さを占める
**AND** 下エリアは50%の高さを占める

#### Scenario: 2分割（縦）テンプレート選択 - 60/40
**GIVEN** ユーザーがテンプレート選択画面にいる
**WHEN** ユーザーが「2分割（縦）60/40」テンプレートを選択する
**THEN** システムは上下2つのエリアを表示する
**AND** 上エリアは60%の高さを占める
**AND** 下エリアは40%の高さを占める

#### Scenario: 2分割（横）テンプレート選択 - 50/50
**GIVEN** ユーザーがテンプレート選択画面にいる
**WHEN** ユーザーが「2分割（横）50/50」テンプレートを選択する
**THEN** システムは左右2つのエリアを表示する
**AND** 左エリアは50%の幅を占める
**AND** 右エリアは50%の幅を占める

#### Scenario: 3分割（縦）テンプレート選択
**GIVEN** ユーザーがテンプレート選択画面にいる
**WHEN** ユーザーが「3分割（縦）33/33/33」テンプレートを選択する
**THEN** システムは上中下3つのエリアを表示する
**AND** 各エリアは33%の高さを占める

#### Scenario: 3分割（グリッド）テンプレート選択 - 上2/下1
**GIVEN** ユーザーがテンプレート選択画面にいる
**WHEN** ユーザーが「3分割（グリッド）上2/下1」テンプレートを選択する
**THEN** システムは3つのエリアを表示する
**AND** 上部に左右2つのエリアが表示される
**AND** 下部に1つのエリアが表示される

#### Scenario: テンプレート再選択
**GIVEN** ユーザーがテンプレートを選択済み
**WHEN** ユーザーが「別のテンプレートを選択」ボタンをクリックする
**THEN** システムはテンプレート選択画面に戻る
**AND** 既に設定した画像データは破棄される
**AND** 確認ダイアログが表示される

### Requirement: エリア別画像アップロード
ユーザーは、各エリアに個別の画像をアップロード・クロップできる **MUST**

#### Scenario: 最初のエリアに画像アップロード
**GIVEN** ユーザーがテンプレートを選択している
**AND** エリア1が選択中
**WHEN** ユーザーが「画像をアップロード」ボタンをクリックする
**THEN** システムはImageCropUploaderを表示する
**AND** ユーザーは画像をドラッグ&ドロップまたは選択できる

#### Scenario: 画像のクロップ
**GIVEN** ユーザーが画像をアップロードした
**WHEN** ユーザーがクロップツールで領域を選択する
**AND** ユーザーが「確定」ボタンをクリックする
**THEN** システムは画像をCloudinaryにアップロードする
**AND** エリアのプレビューに画像が表示される
**AND** 次のエリアが選択中になる

#### Scenario: 2つ目のエリアに画像アップロード
**GIVEN** ユーザーがエリア1に画像を設定済み
**AND** エリア2が選択中
**WHEN** ユーザーがエリア2に画像をアップロードする
**THEN** システムはエリア2に画像を設定する
**AND** エリア2のプレビューが表示される

#### Scenario: 画像の再アップロード
**GIVEN** ユーザーがエリアに画像を設定済み
**WHEN** ユーザーがそのエリアの「画像を変更」ボタンをクリックする
**THEN** システムはImageCropUploaderを再表示する
**AND** ユーザーは新しい画像をアップロードできる
**AND** 古い画像は新しい画像で置き換えられる

#### Scenario: 画像の削除
**GIVEN** ユーザーがエリアに画像を設定済み
**WHEN** ユーザーがそのエリアの「画像を削除」ボタンをクリックする
**THEN** システムは確認ダイアログを表示する
**AND** ユーザーが「削除」を確認すると画像が削除される
**AND** エリアが未設定状態に戻る

### Requirement: 画像合成
システムは、全エリアの画像を1枚の画像に合成できる **MUST**

#### Scenario: 全エリア画像設定完了時の自動合成
**GIVEN** ユーザーがすべてのエリアに画像を設定した
**WHEN** 最後のエリアの画像アップロードが完了する
**THEN** システムはCloudinaryで画像合成を開始する
**AND** ローディングインジケーターを表示する
**AND** 合成完了後、プレビューを表示する

#### Scenario: Cloudinary画像合成
**GIVEN** テンプレート定義（座標とサイズ）が存在する
**AND** 各エリアの画像URLが存在する
**WHEN** システムが画像合成を実行する
**THEN** Cloudinary Transformations APIを呼び出す
**AND** テンプレートの座標定義に基づいて各画像を配置する
**AND** 1枚の合成画像URLを取得する

#### Scenario: 画像合成エラー処理
**GIVEN** 画像合成中にCloudinaryがエラーを返す
**WHEN** エラーが発生する
**THEN** システムはエラーメッセージを表示する
**AND** 「再試行」ボタンを表示する
**AND** ユーザーは再試行または画像を再選択できる

### Requirement: プレビュー表示
ユーザーは、合成後の画像をリアルタイムでプレビューできる **MUST**

#### Scenario: 合成画像のプレビュー
**GIVEN** ユーザーが全エリアに画像を設定済み
**AND** 画像合成が完了している
**WHEN** ユーザーがプレビューエリアを確認する
**THEN** システムは合成後の画像を表示する
**AND** 実際のサイズ（1024x1024pxなど）で表示する

#### Scenario: プレビューのズーム
**GIVEN** プレビュー画像が表示されている
**WHEN** ユーザーがズームインボタンをクリックする
**THEN** プレビュー画像が拡大表示される
**AND** ユーザーは詳細を確認できる

### Requirement: 進捗管理
ユーザーは、現在の設定進捗を確認できる **MUST**

#### Scenario: 進捗表示
**GIVEN** ユーザーがテンプレートを選択している
**WHEN** ユーザーがエリア設定画面を表示する
**THEN** システムは進捗インジケーターを表示する
**AND** 「2/3エリア完了」のような表示がされる

#### Scenario: 未完了エリアのハイライト
**GIVEN** 一部のエリアのみ画像が設定されている
**WHEN** ユーザーが画面を確認する
**THEN** 未設定のエリアは枠線やアイコンで強調表示される
**AND** ユーザーは次に設定すべきエリアがわかる

### Requirement: 送信制御
システムは、全エリアに画像が設定されるまで送信を許可しない **MUST**

#### Scenario: 送信ボタンの無効化
**GIVEN** ユーザーがテンプレートを選択している
**AND** 一部のエリアが未設定
**WHEN** ユーザーが送信ボタンを確認する
**THEN** 送信ボタンは無効化（グレーアウト）されている
**AND** ツールチップで「全エリアに画像を設定してください」と表示される

#### Scenario: 送信ボタンの有効化
**GIVEN** ユーザーが全エリアに画像を設定済み
**AND** 画像合成が完了している
**WHEN** ユーザーが送信ボタンを確認する
**THEN** 送信ボタンは有効化されている
**AND** クリック可能な状態

#### Scenario: 送信実行
**GIVEN** 全エリアに画像が設定済み
**AND** 送信ボタンが有効化されている
**WHEN** ユーザーが送信ボタンをクリックする
**THEN** システムは合成画像を含むImagemapメッセージを作成する
**AND** LINE Messaging APIに送信する
**AND** 成功メッセージを表示する

### Requirement: データ永続化
システムは、編集中のデータをローカルストレージに保存できる **SHOULD**

#### Scenario: 自動保存
**GIVEN** ユーザーが画像をアップロードした
**WHEN** 画像アップロードが完了する
**THEN** システムはデータをlocalStorageに保存する
**AND** ページリロード後もデータが復元される

#### Scenario: データ復元
**GIVEN** ユーザーが以前にテンプレートと画像を設定した
**AND** ブラウザを閉じた
**WHEN** ユーザーが再度エディタを開く
**THEN** システムは前回の状態を復元する
**AND** 選択したテンプレートと画像が表示される

### Requirement: バリデーション
システムは、画像とテンプレートの整合性を検証できる **MUST**

#### Scenario: 画像サイズバリデーション
**GIVEN** ユーザーが画像をアップロードしようとしている
**AND** 画像サイズが2500x2500pxを超えている
**WHEN** アップロードを実行する
**THEN** システムはエラーメッセージを表示する
**AND** 「画像サイズは2500x2500px以下にしてください」と表示する

#### Scenario: 画像形式バリデーション
**GIVEN** ユーザーが非対応形式（GIFなど）をアップロードしようとしている
**WHEN** アップロードを実行する
**THEN** システムはエラーメッセージを表示する
**AND** 「JPEG/PNG形式のみ対応しています」と表示する

### Requirement: レスポンシブ対応
システムは、デスクトップ・タブレット・モバイルで適切に表示される **SHOULD**

#### Scenario: デスクトップ表示
**GIVEN** ユーザーがデスクトップブラウザでアクセスしている
**WHEN** エディタを表示する
**THEN** 横並びレイアウトで表示される
**AND** テンプレート選択とプレビューが同時に見える

#### Scenario: モバイル表示
**GIVEN** ユーザーがモバイルブラウザでアクセスしている
**WHEN** エディタを表示する
**THEN** 縦並びレイアウトで表示される
**AND** ステップバイステップのUIになる

### Requirement: アクセシビリティ
システムは、キーボード操作とスクリーンリーダーに対応する **SHOULD**

#### Scenario: キーボードナビゲーション
**GIVEN** ユーザーがキーボードのみで操作している
**WHEN** Tabキーを押す
**THEN** フォーカスが論理的な順序で移動する
**AND** 現在のフォーカス位置が視覚的に明確

#### Scenario: スクリーンリーダー対応
**GIVEN** ユーザーがスクリーンリーダーを使用している
**WHEN** エディタを使用する
**THEN** 各エリアに適切なARIAラベルが付与されている
**AND** 進捗状況が読み上げられる

## REMOVED Requirements

### Requirement: 自由描画機能（削除）
~~ユーザーは、画像上に自由に領域を描画できる~~

**削除理由**: テンプレート方式に完全置き換えのため

### Requirement: キャンバスドラッグ&リサイズ（削除）
~~ユーザーは、領域をドラッグして移動・リサイズできる~~

**削除理由**: テンプレート方式では座標固定のため

### Requirement: 領域へのアクション設定（削除）
~~ユーザーは、各領域にURI/Message/Postbackアクションを設定できる~~

**削除理由**: ユーザー要望により、アクション不要（画像表示のみ）

### Requirement: テキストラベルオーバーレイ（削除）
~~システムは、領域のラベルテキストを画像上に合成できる~~

**削除理由**: アクション不要のため、ラベルも不要

## Success Criteria

以下の条件をすべて満たす場合、このcapabilityは成功とみなされる:

1. ✅ ユーザーが1-3分割のテンプレートを選択できる
2. ✅ 各エリアに個別の画像をアップロード・クロップできる
3. ✅ 全エリア画像設定後、自動的に画像が合成される
4. ✅ 合成画像がリアルタイムでプレビュー表示される
5. ✅ 全エリア設定完了まで送信ボタンが無効化される
6. ✅ LINE Imagemapメッセージとして正常に送信できる
7. ✅ 既存の自由描画機能が完全に削除されている
8. ✅ すべてのテストが合格している
9. ✅ ブラウザ互換性が確保されている（Chrome, Firefox, Safari, Edge）
10. ✅ レスポンシブデザインが適切に動作している
