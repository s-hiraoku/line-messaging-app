# Proposal: Add Message Items Sending Feature

## Summary

LINE Official Account Manager (https://manager.line.biz/) で作成したメッセージアイテム（リッチメッセージ、カードタイプメッセージ）を、ダッシュボードから個別ユーザーに送信できる機能を追加します。

## Motivation

- **現状の課題**:
  - 現在のダッシュボードでは通常のメッセージ（テキスト、画像、動画等）の送信のみサポート
  - LINE Official Account Manager で作成したリッチメッセージやカードタイプメッセージを送信する手段がない
  - LINE Manager の管理画面に切り替える必要があり、運用効率が低下

- **ビジネス価値**:
  - 視覚的に魅力的なメッセージ（リッチメッセージ、カードタイプメッセージ）を簡単に送信可能
  - LINE Manager で作成したメッセージアイテムを一元管理・配信できる
  - プロモーションやキャンペーンの訴求力向上

- **ユーザー体験の向上**:
  - 単一のダッシュボードで全てのメッセージタイプを管理・送信可能
  - メッセージIDを指定するだけで送信できるシンプルなUI

## Goals

1. **メッセージアイテム送信機能**: LINE Manager で作成したメッセージアイテムを個別ユーザーに送信
2. **ユーザー選択UI**: ユーザー一覧から送信対象を選択できるコンポーネント
3. **送信履歴の記録**: メッセージアイテムの送信履歴をデータベースに保存
4. **デバッグ情報の表示**: API リクエスト/レスポンス情報を開発モードで表示

## Non-Goals

- メッセージアイテムの作成・編集機能（LINE Manager で作成することを前提）
- メッセージアイテムのプレビュー表示（初期バージョンでは対応しない）
- 一斉配信機能（個別送信のみ）
- 自動返信システムへの統合（将来的な拡張として検討）

## Proposed Solution

### アーキテクチャ概要

1. **新規ページ**: `/dashboard/message-items`
   - メッセージアイテム送信専用画面
   - ユーザー選択 + メッセージタイプ選択 + メッセージID入力

2. **ユーザー選択コンポーネント（新規）**:
   - `/api/users` からユーザー一覧を取得
   - Combobox/Autocomplete 形式で検索・選択
   - 表示名、lineUserId、アイコン画像を表示

3. **API 拡張**:
   - 既存の `/api/line/send` エンドポイントを拡張、またはメッセージアイテム専用のペイロードを追加
   - LINE Messaging API の仕様に従ってメッセージアイテムを送信

4. **データモデル**:
   - 既存の `Message` モデルで送信履歴を記録
   - 必要に応じて `MessageType` enum に新しいタイプを追加

### 主要機能

1. **メッセージタイプ選択**:
   - リッチメッセージ（Rich Message）
   - カードタイプメッセージ（Card-type Message）

2. **メッセージID入力**:
   - LINE Manager で作成したメッセージアイテムのID
   - フォーマット検証

3. **送信処理**:
   - LINE Messaging API を使用してメッセージアイテムを送信
   - 送信結果をデータベースに記録

4. **DebugPanel**:
   - API リクエスト内容
   - レスポンスステータスとデータ
   - cURL コマンド表示
   - 開発モードのみ表示

## Affected Capabilities

- **message-items**: 新規追加 - メッセージアイテムの送信機能

## Alternatives Considered

### 1. Flex Message でカード形式を実装
- **却下理由**: LINE Manager で作成した既存のメッセージアイテムを活用できない。初期実装では既存アセットを活用する方が効率的。

### 2. 自動返信システムに統合
- **却下理由**: まず手動送信機能を実装し、動作確認後に自動返信への統合を検討する段階的アプローチが適切。

### 3. メッセージアイテムのプレビュー機能を含める
- **却下理由**: LINE API でメッセージアイテムのメタデータ取得が必要。初期バージョンでは送信機能に集中し、プレビューは将来的な拡張として検討。

## Migration Strategy

1. **既存機能への影響**:
   - 既存のメッセージ送信機能には影響なし
   - 新規ページの追加のみ

2. **データベースマイグレーション**:
   - `MessageType` enum への追加が必要な場合のみマイグレーション実行
   - 既存データへの影響なし

3. **段階的なロールアウト**:
   - フェーズ1: LINE Messaging API の調査と仕様確認
   - フェーズ2: ユーザー選択コンポーネントの実装
   - フェーズ3: メッセージアイテム送信フォームとAPI実装
   - フェーズ4: ナビゲーション追加とテスト

## Technical Considerations

### LINE Messaging API 調査項目
以下の仕様を確認する必要があります：

1. **リッチメッセージの送信方法**:
   - エンドポイント
   - リクエストボディのフォーマット
   - メッセージIDの指定方法

2. **カードタイプメッセージの送信方法**:
   - Narrowcast API の使用可否
   - メッセージオブジェクトの構造

3. **エラーハンドリング**:
   - 無効なメッセージID
   - メッセージアイテムが削除されている場合

## Success Metrics

- メッセージアイテム送信機能の利用回数
- 送信成功率（エラー発生率）
- ユーザー選択UIの使いやすさ（操作時間）

## Timeline

- API 調査: 1-2日
- 実装: 3-5日
- テスト: 1-2日

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|-----------|
| LINE API 仕様の不明瞭さ | High | 公式ドキュメント調査と実験的実装で早期に確認 |
| 無効なメッセージIDの入力 | Medium | バリデーションとエラーメッセージの実装 |
| メッセージアイテムのプレビューなし | Low | メッセージIDと共にメモやタグを保存できる機能を検討 |
